import React, { useState, useEffect } from 'react';
import { 
  Shield, 
  Database, 
  Users, 
  Truck, 
  Lock, 
  Menu, 
  X, 
  LogIn, 
  LogOut, 
  Search, 
  FileText, 
  Settings,
  Activity,
  Server,
  Eye,
  EyeOff,
  BarChart2,
  PieChart,
  Map,
  ExternalLink,
  Filter,
  Maximize2,
  Fingerprint, 
  ShieldCheck, 
  FileKey,     
  History,     
  AlertTriangle,
  Download,      
  Tag,           
  ChevronDown,   
  ChevronUp,     
  FileSpreadsheet, 
  CheckSquare,
  Upload,         
  AlertCircle,    
  CheckCircle,    
  RefreshCw,      
  FileJson,       
  File,
  MessageSquare,
  Clock,
  UserCheck,
  UserX,
  Send,
  Share2,       
  GitBranch,    
  ArrowLeft     
} from 'lucide-react';

// --- Mock Data & Constants ---

const ROLES = {
  GUEST: 'guest',
  EMPLOYEE: 'employee',
  SUPPLIER: 'supplier',
  ADMIN: 'admin'
};

const MOCK_DATA_CATALOG = [
  { 
    id: 1, 
    name: 'נתוני מכירות Q3', 
    type: 'Excel', 
    classification: 'סודי ביותר', 
    owner: 'מחלקת כספים',
    department: 'finance',
    tags: ['כספים', '2024', 'דוח רבעוני'],
    size: '4.2 MB',
    qualityScore: 98,
    lastUpdate: '10/05/2024'
  },
  { 
    id: 2, 
    name: 'רשימת עובדים פעילים', 
    type: 'SQL View', 
    classification: 'פנימי', 
    owner: 'משאבי אנוש',
    department: 'hr',
    tags: ['HR', 'עובדים', 'שכר'],
    size: 'Query',
    qualityScore: 100,
    lastUpdate: 'היום'
  },
  { 
    id: 3, 
    name: 'קטלוג מוצרים ציבורי', 
    type: 'JSON API', 
    classification: 'ציבורי', 
    owner: 'שיווק',
    department: 'marketing',
    tags: ['API', 'מוצרים', 'e-commerce'],
    size: 'Live Stream',
    qualityScore: 92,
    lastUpdate: 'אוטומטי'
  },
  { 
    id: 4, 
    name: 'לוגים של שרתים', 
    type: 'Elastic', 
    classification: 'סודי', 
    owner: 'IT',
    department: 'it',
    tags: ['Logs', 'Security', 'Infrastructure'],
    size: '250 GB',
    qualityScore: 85,
    lastUpdate: 'בזמן אמת'
  },
];

const MOCK_SUPPLIER_ORDERS = [
  { id: 'ORD-2024-001', date: '2024-05-01', status: 'אושר', amount: '₪45,000' },
  { id: 'ORD-2024-002', date: '2024-05-03', status: 'בטיפול', amount: '₪12,500' },
  { id: 'ORD-2024-005', date: '2024-05-10', status: 'נשלח', amount: '₪3,200' },
];

const MOCK_USERS = [
  { id: 1, name: 'ישראל ישראלי', role: 'employee', status: 'active', department: 'finance' },
  { id: 2, name: 'חברת אספקה בע"מ', role: 'supplier', status: 'active', department: 'external' },
  { id: 3, name: 'מנהל מערכת', role: 'admin', status: 'active', department: 'it' },
];

const MOCK_PUBLIC_DASHBOARDS = [
  { 
    id: 1, 
    title: 'מדדי ביצוע מרכזיים (KPIs) - 2024', 
    description: 'סקירה שנתית של ביצועי החברה, יעדי צמיחה ומדדים פיננסיים.',
    system: 'PowerBI', 
    category: 'פיננסי',
    views: '12.5K',
    updated: '12/05/2024',
    icon: BarChart2,
    color: 'bg-yellow-500'
  },
  { 
    id: 2, 
    title: 'מפת פריסה ארצית - תשתיות', 
    description: 'מפה אינטראקטיבית המציגה את פריסת הסיבים והאנטנות ברחבי הארץ.',
    system: 'Tableau', 
    category: 'תפעול',
    views: '8.2K',
    updated: '10/05/2024',
    icon: Map,
    color: 'bg-blue-500'
  },
  { 
    id: 3, 
    title: 'דוח שביעות רצון לקוחות', 
    description: 'ניתוח סקרי שביעות רצון, זמני המתנה במוקד ופניות פתוחות.',
    system: 'Looker', 
    category: 'שירות',
    views: '5.6K',
    updated: '09/05/2024',
    icon: PieChart,
    color: 'bg-purple-500'
  },
  { 
    id: 4, 
    title: 'צריכת אנרגיה ומדדי קיימות', 
    description: 'דשבורד בזמן אמת המציג את צריכת החשמל והחיסכון באנרגיה במשרדים.',
    system: 'Custom', 
    category: 'קיימות',
    views: '2.1K',
    updated: 'היום',
    icon: Activity,
    color: 'bg-green-500'
  },
];

const MOCK_SECURE_DASHBOARDS = [
  { 
    id: 101, 
    title: 'ניהול תקציב ומשכורות', 
    sensitivity: 'HIGH', 
    requiredGroup: 'finance', 
    system: 'SAP Analytics',
    lastAccess: 'לפני יומיים'
  },
  { 
    id: 102, 
    title: 'תיקים אישיים (HR Sensitive)', 
    sensitivity: 'HIGH', 
    requiredGroup: 'hr', 
    system: 'Workday',
    lastAccess: 'מעולם לא'
  },
  { 
    id: 103, 
    title: 'מלאי מחסנים ראשי', 
    sensitivity: 'MEDIUM', 
    requiredGroup: 'logistics', // User doesn't have this
    system: 'PowerBI',
    lastAccess: '-'
  },
  { 
    id: 104, 
    title: 'ביצועי שרתים (Admin)', 
    sensitivity: 'MEDIUM', 
    requiredGroup: 'it', // Admin has this
    system: 'Grafana',
    lastAccess: 'היום, 08:00'
  }
];

const MOCK_ACCESS_REQUESTS = [
  { id: 1, userId: 1, userName: 'ישראל ישראלי', resource: 'מלאי מחסנים ראשי', reason: 'נדרש לצורך ספירת מלאי רבעונית', status: 'pending', date: '2024-05-18', log: [] },
  { id: 2, userId: 1, userName: 'ישראל ישראלי', resource: 'דוח שכר בכירים', reason: 'ביקורת פנימית', status: 'rejected', date: '2024-05-15', log: ['נדחה ע"י Admin: אין הרשאה מתאימה'] },
  { id: 3, userId: 2, userName: 'חברת אספקה בע"מ', resource: 'קטלוג מחירים סיטונאי', reason: 'עדכון מחירון', status: 'approved', date: '2024-05-10', log: ['אושר ע"י Admin'] },
];

// --- Components ---

// 1. Navigation Bar
const Navbar = ({ currentUser, currentView, setView, handleLogin, handleLogout }) => {
  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);

  const NavItem = ({ view, label, icon: Icon, allowedRoles }) => {
    if (allowedRoles && (!currentUser || !allowedRoles.includes(currentUser.role))) {
      return null;
    }
    
    return (
      <button
        onClick={() => {
          setView(view);
          setIsMobileMenuOpen(false);
        }}
        className={`flex items-center gap-2 px-4 py-2 rounded-lg transition-colors duration-200 w-full md:w-auto text-right md:text-center
          ${currentView === view 
            ? 'bg-blue-600 text-white shadow-md' 
            : 'text-slate-600 hover:bg-slate-100 hover:text-blue-600'}`}
      >
        <Icon size={18} />
        <span className="font-medium">{label}</span>
      </button>
    );
  };

  return (
    <nav className="bg-white shadow-lg sticky top-0 z-50 border-b border-slate-200">
      <div className="max-w-7xl mx-auto px-4">
        <div className="flex justify-between h-16">
          {/* Logo & Brand */}
          <div className="flex items-center gap-2 cursor-pointer" onClick={() => setView('public')}>
            <div className="bg-blue-600 p-2 rounded-lg">
              <Shield className="text-white" size={24} />
            </div>
            <span className="text-xl font-bold text-blue-600 hidden sm:block">מערכת אמו"ן מוניציפלי</span>
          </div>

          <div className="hidden md:flex items-center space-x-1 space-x-reverse">
            <NavItem view="public" label="בית" icon={Server} />
            <NavItem view="public-dashboards" label="דשבורדים" icon={BarChart2} />
            <NavItem view="authorized" label="אזור אישי" icon={Activity} allowedRoles={[ROLES.EMPLOYEE, ROLES.ADMIN]} />
            <NavItem view="catalog" label="קטלוג דאטה" icon={Database} allowedRoles={[ROLES.EMPLOYEE, ROLES.ADMIN]} />
            <NavItem view="supplier" label="פורטל ספקים" icon={Truck} allowedRoles={[ROLES.SUPPLIER, ROLES.ADMIN]} />
            <NavItem view="admin" label="ניהול" icon={Lock} allowedRoles={[ROLES.ADMIN]} />
            <NavItem view="workflow" label="תרשים מערכת" icon={GitBranch} allowedRoles={[ROLES.ADMIN, ROLES.EMPLOYEE, ROLES.GUEST]} />
          </div>

          <div className="flex items-center gap-4">
            {currentUser ? (
              <div className="flex items-center gap-3">
                <span className="text-sm font-medium text-slate-600 hidden md:block">
                  שלום, {currentUser.name}
                </span>
                <button 
                  onClick={handleLogout}
                  className="flex items-center gap-1 text-red-500 hover:bg-red-50 px-3 py-1.5 rounded-md text-sm transition"
                >
                  <LogOut size={16} />
                  <span className="hidden md:inline">התנתק</span>
                </button>
              </div>
            ) : (
              <button 
                onClick={() => setView('login')}
                className="flex items-center gap-1 bg-slate-800 text-white px-4 py-2 rounded-lg hover:bg-slate-700 transition"
              >
                <LogIn size={16} />
                <span>התחברות</span>
              </button>
            )}

            <button 
              className="md:hidden p-2 text-slate-600"
              onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)}
            >
              {isMobileMenuOpen ? <X /> : <Menu />}
            </button>
          </div>
        </div>
      </div>

      {isMobileMenuOpen && (
        <div className="md:hidden bg-white border-t border-slate-100 p-4 space-y-2 shadow-xl absolute w-full z-50">
          <NavItem view="public" label="בית" icon={Server} />
          <NavItem view="public-dashboards" label="דשבורדים ציבוריים" icon={BarChart2} />
          <NavItem view="authorized" label="אזור אישי" icon={Activity} allowedRoles={[ROLES.EMPLOYEE, ROLES.ADMIN]} />
          <NavItem view="catalog" label="קטלוג דאטה" icon={Database} allowedRoles={[ROLES.EMPLOYEE, ROLES.ADMIN]} />
          <NavItem view="supplier" label="פורטל ספקים" icon={Truck} allowedRoles={[ROLES.SUPPLIER, ROLES.ADMIN]} />
          <NavItem view="admin" label="ניהול הרשאות" icon={Lock} allowedRoles={[ROLES.ADMIN]} />
          <NavItem view="workflow" label="תרשים מערכת" icon={GitBranch} allowedRoles={[ROLES.ADMIN, ROLES.EMPLOYEE, ROLES.GUEST]} />
        </div>
      )}
    </nav>
  );
};

// 2. Public Site Module
const PublicSite = () => (
  <div className="animate-fade-in">
    <div className="bg-gradient-to-br from-slate-900 to-blue-900 text-white py-20 px-4 text-center rounded-b-[3rem] shadow-2xl mb-12">
      <h1 className="text-4xl md:text-6xl font-bold mb-6">תשתית ארגונית אחודה</h1>
      <p className="text-xl text-blue-100 max-w-2xl mx-auto mb-8">
        פלטפורמה מרכזית המאגדת את כלל השירותים הדיגיטליים של הארגון תחת קורת גג אחת, מאובטחת ונגישה.
      </p>
      <div className="flex justify-center gap-4 flex-wrap">
        <div className="bg-white/10 backdrop-blur-md p-4 rounded-xl border border-white/20">
          <Shield className="mx-auto mb-2 text-blue-300" />
          <span className="font-semibold">אבטחה מתקדמת</span>
        </div>
        <div className="bg-white/10 backdrop-blur-md p-4 rounded-xl border border-white/20">
          <Activity className="mx-auto mb-2 text-green-300" />
          <span className="font-semibold">זמינות גבוהה</span>
        </div>
        <div className="bg-white/10 backdrop-blur-md p-4 rounded-xl border border-white/20">
          <Users className="mx-auto mb-2 text-purple-300" />
          <span className="font-semibold">חווית משתמש</span>
        </div>
      </div>
    </div>
    
    <div className="max-w-7xl mx-auto px-4 grid md:grid-cols-3 gap-8 mb-16">
      <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition">
        <h3 className="text-xl font-bold mb-3 text-slate-800">אודות החברה</h3>
        <p className="text-slate-600">אנחנו מובילים את תחום התשתיות הדיגיטליות בישראל משנת 2005, עם דגש על חדשנות וקיימות.</p>
      </div>
      <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition">
        <h3 className="text-xl font-bold mb-3 text-slate-800">חדשות ועדכונים</h3>
        <p className="text-slate-600">הושק מודול הספקים החדש המאפשר שקיפות מלאה בתהליכי הרכש והאספקה.</p>
      </div>
      <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition">
        <h3 className="text-xl font-bold mb-3 text-slate-800">צור קשר</h3>
        <p className="text-slate-600">מוקד התמיכה שלנו זמין עבורכם 24/7 לכל שאלה בנושא המערכות הדיגיטליות.</p>
      </div>
    </div>
  </div>
);

// 2.5 Public Dashboards Module
const PublicDashboards = () => {
  const [selectedDashboard, setSelectedDashboard] = useState(null);
  const [filter, setFilter] = useState('all');
  const [searchTerm, setSearchTerm] = useState('');

  const categories = ['all', ...new Set(MOCK_PUBLIC_DASHBOARDS.map(d => d.category))];

  const filteredDashboards = MOCK_PUBLIC_DASHBOARDS.filter(d => {
    const matchesFilter = filter === 'all' || d.category === filter;
    const matchesSearch = d.title.toLowerCase().includes(searchTerm.toLowerCase()) || 
                          d.system.toLowerCase().includes(searchTerm.toLowerCase());
    return matchesFilter && matchesSearch;
  });

  const DashboardViewer = ({ data, onClose }) => (
    <div className="fixed inset-0 bg-slate-900/80 z-[60] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
      <div className="bg-white w-full max-w-6xl h-[90vh] rounded-2xl flex flex-col shadow-2xl overflow-hidden">
        <div className="bg-slate-50 border-b p-4 flex justify-between items-center">
          <div className="flex items-center gap-3">
            <div className={`p-2 rounded-lg ${data.color} text-white shadow-sm`}>
              <data.icon size={20} />
            </div>
            <div>
              <h3 className="font-bold text-lg text-slate-800">{data.title}</h3>
              <div className="flex items-center gap-2 text-xs text-slate-500">
                <span>מקור: {data.system}</span>
                <span>•</span>
                <span>עודכן: {data.updated}</span>
              </div>
            </div>
          </div>
          <div className="flex items-center gap-2">
             <button className="p-2 hover:bg-slate-200 rounded-lg text-slate-600 hidden md:flex items-center gap-1 transition">
              <ExternalLink size={18} />
              <span className="text-sm">פתח בחלון חדש</span>
            </button>
            <button onClick={onClose} className="p-2 hover:bg-red-50 text-slate-400 hover:text-red-500 rounded-lg transition">
              <X size={24} />
            </button>
          </div>
        </div>

        <div className="flex-grow bg-slate-100 p-6 overflow-y-auto">
          <div className="bg-white p-3 rounded-lg shadow-sm mb-6 flex flex-wrap gap-4 items-center border border-slate-200">
            <span className="text-sm font-bold text-slate-600 flex items-center gap-1">
              <Filter size={14} /> סינון דוח:
            </span>
            <select className="bg-slate-50 border rounded px-2 py-1 text-sm"><option>הכל</option><option>2024</option><option>2023</option></select>
            <select className="bg-slate-50 border rounded px-2 py-1 text-sm"><option>כל הסניפים</option><option>מרכז</option><option>צפון</option></select>
            <div className="flex-grow"></div>
            <button className="text-blue-600 text-sm hover:underline">נקה סינון</button>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-3 gap-6 h-full min-h-[500px]">
            <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex flex-col col-span-2">
              <h4 className="font-bold text-slate-700 mb-4">מגמות לאורך זמן</h4>
              <div className="flex-grow flex items-end justify-between gap-2 px-2 pb-2">
                {[40, 65, 45, 80, 55, 90, 70, 85, 60, 75, 50, 95].map((h, i) => (
                  <div key={i} className="w-full bg-blue-100 hover:bg-blue-500 transition-colors rounded-t-sm relative group" style={{ height: `${h}%` }}>
                    <div className="absolute -top-8 left-1/2 -translate-x-1/2 bg-slate-800 text-white text-xs py-1 px-2 rounded opacity-0 group-hover:opacity-100 transition whitespace-nowrap z-10">
                      {h * 100} יחידות
                    </div>
                  </div>
                ))}
              </div>
              <div className="border-t mt-2 pt-2 flex justify-between text-xs text-slate-400">
                <span>ינואר</span><span>יוני</span><span>דצמבר</span>
              </div>
            </div>

            <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex flex-col">
              <h4 className="font-bold text-slate-700 mb-4">התפלגות לפי סוג</h4>
              <div className="flex-grow flex items-center justify-center relative">
                <div className="w-48 h-48 rounded-full border-[16px] border-orange-400 border-r-blue-500 border-b-green-400 transform rotate-45"></div>
                <div className="absolute text-center">
                  <div className="text-2xl font-bold">100%</div>
                  <div className="text-xs text-slate-500">סה"כ</div>
                </div>
              </div>
              <div className="mt-4 space-y-2">
                <div className="flex items-center justify-between text-sm">
                  <span className="flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-blue-500"></div> סוג א'</span>
                  <span className="font-bold">45%</span>
                </div>
                <div className="flex items-center justify-between text-sm">
                  <span className="flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-orange-400"></div> סוג ב'</span>
                  <span className="font-bold">30%</span>
                </div>
                 <div className="flex items-center justify-between text-sm">
                  <span className="flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-green-400"></div> סוג ג'</span>
                  <span className="font-bold">25%</span>
                </div>
              </div>
            </div>

            <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 md:col-span-3 flex flex-col">
              <h4 className="font-bold text-slate-700 mb-4">טבלת נתונים מסכמת</h4>
               <div className="overflow-x-auto">
                <table className="w-full text-right text-sm">
                  <thead className="bg-slate-50 text-slate-600">
                    <tr>
                      <th className="p-2">קטגוריה</th>
                      <th className="p-2">יעד</th>
                      <th className="p-2">ביצוע בפועל</th>
                      <th className="p-2">סטטוס</th>
                    </tr>
                  </thead>
                  <tbody>
                    {[1,2,3].map(i => (
                      <tr key={i} className="border-b">
                        <td className="p-2">מדד {i}</td>
                        <td className="p-2">1,000</td>
                        <td className="p-2 font-bold">9{i}0</td>
                        <td className="p-2"><span className="text-green-600 bg-green-50 px-2 py-0.5 rounded text-xs">תקין</span></td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );

  return (
    <div className="max-w-7xl mx-auto px-4 py-8 animate-fade-in">
      <header className="mb-10 text-center md:text-right">
        <h2 className="text-3xl font-bold text-slate-800 flex items-center justify-center md:justify-start gap-3">
          <BarChart2 className="text-blue-600" size={32} />
          דשבורדים ודוחות ציבוריים
        </h2>
        <p className="text-slate-500 mt-2 max-w-2xl">
          מאגר הדוחות הפתוחים של הארגון. מאפשר גישה מהירה לנתוני ביצועים, שקיפות ומידע לציבור ללא צורך בהזדהות.
        </p>
      </header>

      <div className="flex flex-col md:flex-row justify-between items-center gap-4 mb-8 bg-white p-4 rounded-xl shadow-sm border border-slate-100">
        <div className="flex items-center gap-2 overflow-x-auto w-full md:w-auto pb-2 md:pb-0">
          {categories.map(cat => (
            <button
              key={cat}
              onClick={() => setFilter(cat)}
              className={`px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-colors
                ${filter === cat 
                  ? 'bg-slate-800 text-white' 
                  : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}
            >
              {cat === 'all' ? 'הכל' : cat}
            </button>
          ))}
        </div>
        
        <div className="relative w-full md:w-64">
          <input 
            type="text" 
            placeholder="חיפוש דוח..." 
            className="w-full pl-4 pr-10 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition"
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
          />
          <Search className="absolute top-2.5 right-3 text-slate-400" size={18} />
        </div>
      </div>

      <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
        {filteredDashboards.map(dash => (
          <div 
            key={dash.id} 
            onClick={() => setSelectedDashboard(dash)}
            className="group bg-white rounded-2xl p-6 border border-slate-200 shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all duration-300 cursor-pointer"
          >
            <div className="flex justify-between items-start mb-4">
              <div className={`p-3 rounded-xl ${dash.color} text-white shadow-md group-hover:scale-110 transition-transform`}>
                <dash.icon size={24} />
              </div>
              <span className="bg-slate-50 text-slate-600 text-xs px-2 py-1 rounded border border-slate-100 font-mono">
                {dash.system}
              </span>
            </div>
            
            <h3 className="text-xl font-bold text-slate-800 mb-2 group-hover:text-blue-600 transition-colors">
              {dash.title}
            </h3>
            <p className="text-slate-500 text-sm mb-6 line-clamp-2 h-10">
              {dash.description}
            </p>

            <div className="flex items-center justify-between pt-4 border-t border-slate-100 text-xs text-slate-400">
              <div className="flex items-center gap-1">
                <Eye size={14} /> {dash.views} צפיות
              </div>
              <div className="flex items-center gap-1">
                 עודכן: {dash.updated}
              </div>
            </div>
          </div>
        ))}
      </div>

      {filteredDashboards.length === 0 && (
        <div className="text-center py-20 text-slate-400 bg-slate-50 rounded-2xl border border-dashed border-slate-200">
          <BarChart2 className="mx-auto mb-2 opacity-50" size={48} />
          <p>לא נמצאו דשבורדים התואמים את החיפוש</p>
        </div>
      )}

      {selectedDashboard && (
        <DashboardViewer data={selectedDashboard} onClose={() => setSelectedDashboard(null)} />
      )}
    </div>
  );
};

// 3. Authorized Dashboard Module
const AuthorizedSite = ({ user, requests, onRequestSubmit }) => {
  const [isGovIdAuthenticated, setIsGovIdAuthenticated] = useState(false);
  const [auditLogs, setAuditLogs] = useState([]);
  const [showRequestModal, setShowRequestModal] = useState(false);
  const [newRequestData, setNewRequestData] = useState({ resource: '', reason: '' });

  const myRequests = requests.filter(r => r.userId === user.id);

  const addLog = (action, status, dashboard) => {
    const newLog = {
      id: Date.now(),
      timestamp: new Date().toLocaleTimeString(),
      action,
      status,
      dashboard,
      user: user.name
    };
    setAuditLogs(prev => [newLog, ...prev].slice(0, 5));
  };

  const handleDashboardAccess = (dashboard) => {
    const hasPermission = user.role === 'admin' || 
                          (user.department === dashboard.requiredGroup) ||
                          (!dashboard.requiredGroup);

    if (!hasPermission) {
      addLog('ניסיון גישה לדשבורד', 'נדחה (הרשאות)', dashboard.title);
      const wantToRequest = window.confirm(`אין לך הרשאות לצפייה בדשבורד זה.\nהאם ברצונך להגיש בקשת גישה למנהל המערכת?`);
      if (wantToRequest) {
        setNewRequestData({ ...newRequestData, resource: dashboard.title });
        setShowRequestModal(true);
      }
      return;
    }

    if (dashboard.sensitivity === 'HIGH' && !isGovIdAuthenticated) {
      addLog('ניסיון גישה לדשבורד רגיש', 'נדחה (נדרש GovID)', dashboard.title);
      const confirmAuth = window.confirm(`הדשבורד "${dashboard.title}" מוגדר כרגיש.\nהאם ברצונך לבצע הזדהות ממשלתית (GovID) כעת?`);
      if (confirmAuth) {
        setIsGovIdAuthenticated(true);
        addLog('הזדהות GovID', 'הצלחה', 'מערכת');
        alert('הזדהות GovID בוצעה בהצלחה.');
      }
    } else {
      addLog('גישה לדשבורד', 'אושר', dashboard.title);
      alert(`פותח את דשבורד: ${dashboard.title} (הצפנה TLS 1.3 פעילה)`);
    }
  };

  const submitRequest = (e) => {
    e.preventDefault();
    if (!newRequestData.resource || !newRequestData.reason) return;
    
    onRequestSubmit({
      resource: newRequestData.resource,
      reason: newRequestData.reason,
      userId: user.id,
      userName: user.name
    });
    
    setShowRequestModal(false);
    setNewRequestData({ resource: '', reason: '' });
    addLog('הגשת בקשת גישה', 'המתנה', newRequestData.resource);
  };

  return (
    <div className="max-w-7xl mx-auto px-4 py-8 animate-fade-in">
      <header className="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div>
          <h2 className="text-3xl font-bold text-slate-800">אזור אישי - עובדים</h2>
          <p className="text-slate-500">ברוך הבא, {user.name}. רמת סיווג: {user.role === 'admin' ? 'גבוהה' : 'רגילה'}</p>
        </div>
        <div className="flex gap-2">
          <div className="flex items-center gap-1 bg-green-50 text-green-700 px-3 py-1 rounded-full text-xs font-bold border border-green-200">
            <Lock size={12} /> TLS 1.3 Encrypted
          </div>
           <div className="flex items-center gap-1 bg-blue-50 text-blue-700 px-3 py-1 rounded-full text-xs font-bold border border-blue-200">
            <ShieldCheck size={12} /> GDPR Compliant
          </div>
        </div>
      </header>

      <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-8 flex flex-col md:flex-row items-center justify-between gap-4">
        <div className="flex items-center gap-4">
          <div className={`p-3 rounded-full ${isGovIdAuthenticated ? 'bg-green-100 text-green-600' : 'bg-slate-100 text-slate-400'}`}>
            <Fingerprint size={24} />
          </div>
          <div>
            <h4 className="font-bold text-slate-700">סטטוס הזדהות נוכחי</h4>
            <div className="flex gap-2 text-sm mt-1">
              <span className="flex items-center gap-1 text-green-600 bg-green-50 px-2 py-0.5 rounded">
                <ShieldCheck size={12} /> SSO מחובר
              </span>
              {isGovIdAuthenticated ? (
                <span className="flex items-center gap-1 text-green-600 bg-green-50 px-2 py-0.5 rounded">
                  <Fingerprint size={12} /> GovID מאומת
                </span>
              ) : (
                 <span className="flex items-center gap-1 text-slate-500 bg-slate-100 px-2 py-0.5 rounded">
                  <Lock size={12} /> GovID לא פעיל
                </span>
              )}
            </div>
          </div>
        </div>
        {!isGovIdAuthenticated && (
          <button 
            onClick={() => {
              setIsGovIdAuthenticated(true);
              addLog('הזדהות GovID יזומה', 'הצלחה', 'מערכת');
            }}
            className="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm hover:bg-slate-700 transition flex items-center gap-2"
          >
            <Fingerprint size={16} /> בצע הזדהות ממשלתית
          </button>
        )}
      </div>

      <div className="grid md:grid-cols-3 gap-8">
        <div className="md:col-span-2 space-y-8">
          <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
            <h3 className="text-lg font-bold mb-4 flex items-center gap-2 text-slate-700 border-b pb-4">
              <FileKey className="text-blue-600" />
              מערכת דשבורדים למורשים
            </h3>
            <div className="grid gap-4">
              {MOCK_SECURE_DASHBOARDS.map((dash) => {
                const isHighSec = dash.sensitivity === 'HIGH';
                const isLocked = isHighSec && !isGovIdAuthenticated;

                return (
                  <div key={dash.id} className="flex items-center justify-between p-4 bg-slate-50 rounded-lg hover:bg-slate-100 transition border border-slate-100">
                    <div className="flex items-center gap-4">
                      <div className={`p-2 rounded-lg ${isHighSec ? 'bg-red-100 text-red-600' : 'bg-blue-100 text-blue-600'}`}>
                        {isLocked ? <Lock size={20} /> : <Activity size={20} />}
                      </div>
                      <div>
                        <h4 className="font-bold text-slate-800">{dash.title}</h4>
                        <div className="flex items-center gap-2 text-xs text-slate-500">
                          <span>{dash.system}</span>
                          <span>•</span>
                          <span className={`${isHighSec ? 'text-red-600 font-bold' : 'text-blue-600'}`}>
                            {isHighSec ? 'סיווג גבוה (GovID)' : 'סיווג רגיל'}
                          </span>
                        </div>
                      </div>
                    </div>
                    <button 
                      onClick={() => handleDashboardAccess(dash)}
                      className={`px-3 py-1.5 rounded text-sm font-medium transition
                        ${isLocked 
                          ? 'bg-slate-200 text-slate-500 hover:bg-slate-300' 
                          : 'bg-blue-600 text-white hover:bg-blue-700'}`}
                    >
                      {isLocked ? 'נדרש אימות' : 'פתח דשבורד'}
                    </button>
                  </div>
                );
              })}
            </div>
          </div>

          <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
             <div className="flex justify-between items-center mb-4 border-b pb-4">
                <h3 className="text-lg font-bold flex items-center gap-2 text-slate-700">
                  <MessageSquare className="text-orange-500" />
                  בקשות הגישה שלי
                </h3>
                <button 
                  onClick={() => setShowRequestModal(true)}
                  className="bg-orange-500 text-white px-3 py-1.5 rounded-lg text-sm hover:bg-orange-600 transition flex items-center gap-1"
                >
                  + בקשה חדשה
                </button>
             </div>

             <div className="space-y-3">
                {myRequests.length === 0 && <p className="text-slate-500 text-center py-4">לא נמצאו בקשות גישה פעילות.</p>}
                {myRequests.map(req => (
                  <div key={req.id} className="p-3 bg-slate-50 rounded-lg border border-slate-100 flex items-center justify-between">
                     <div>
                        <div className="font-bold text-slate-800">{req.resource}</div>
                        <div className="text-xs text-slate-500">{req.date} • {req.reason}</div>
                     </div>
                     <div className="flex flex-col items-end gap-1">
                        <span className={`px-2 py-1 rounded text-xs font-bold
                          ${req.status === 'approved' ? 'bg-green-100 text-green-700' : 
                            req.status === 'rejected' ? 'bg-red-100 text-red-700' :
                            'bg-yellow-100 text-yellow-700'}`}>
                          {req.status === 'approved' ? 'מאושר' : req.status === 'rejected' ? 'נדחה' : 'בטיפול'}
                        </span>
                        {req.log.length > 0 && <span className="text-[10px] text-slate-400">{req.log[req.log.length-1]}</span>}
                     </div>
                  </div>
                ))}
             </div>
          </div>
        </div>

        <div className="space-y-6">
          <div className="bg-slate-50 rounded-xl border border-slate-200 p-5">
            <h3 className="text-sm font-bold mb-3 flex items-center gap-2 text-slate-700 uppercase">
              <History size={16} /> יומן פעילות ואבטחה
            </h3>
            <div className="space-y-3">
              {auditLogs.length === 0 && <p className="text-xs text-slate-400">אין פעילות מתועדת בסשן זה.</p>}
              {auditLogs.map((log) => (
                <div key={log.id} className="text-xs border-r-2 border-slate-300 pr-3 relative">
                  <div className="absolute -right-[17px] top-0 w-2 h-2 rounded-full bg-slate-300"></div>
                  <div className="flex justify-between text-slate-500 mb-1">
                    <span>{log.timestamp}</span>
                    <span className={log.status === 'אושר' || log.status === 'הצלחה' ? 'text-green-600 font-bold' : 'text-red-500 font-bold'}>
                      {log.status}
                    </span>
                  </div>
                  <div className="font-medium text-slate-700">{log.action}</div>
                  <div className="text-slate-500 truncate">{log.dashboard}</div>
                </div>
              ))}
            </div>
          </div>

          <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
            <h3 className="text-sm font-bold mb-3 text-slate-700 uppercase">קישורים מהירים</h3>
            <div className="grid grid-cols-2 gap-2">
              <button className="p-2 bg-slate-50 rounded hover:bg-slate-100 text-xs text-slate-700 text-center transition">
                דיווח שעות
              </button>
              <button className="p-2 bg-slate-50 rounded hover:bg-slate-100 text-xs text-slate-700 text-center transition">
                קריאת שירות
              </button>
              <button className="p-2 bg-slate-50 rounded hover:bg-slate-100 text-xs text-slate-700 text-center transition">
                מערכת למידה
              </button>
              <button className="p-2 bg-slate-50 rounded hover:bg-slate-100 text-xs text-slate-700 text-center transition">
                פורטל רווחה
              </button>
            </div>
          </div>
        </div>
      </div>

      {showRequestModal && (
        <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 animate-fade-in">
             <h3 className="text-xl font-bold mb-4 text-slate-800">הגשת בקשת גישה</h3>
             <form onSubmit={submitRequest} className="space-y-4">
                <div>
                   <label className="block text-sm font-medium text-slate-700 mb-1">שם המשאב / דשבורד</label>
                   <input 
                      type="text" 
                      className="w-full border border-slate-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 outline-none"
                      value={newRequestData.resource}
                      onChange={e => setNewRequestData({...newRequestData, resource: e.target.value})}
                      placeholder="לדוגמה: ניהול מלאי"
                      required
                   />
                </div>
                <div>
                   <label className="block text-sm font-medium text-slate-700 mb-1">סיבת הבקשה</label>
                   <textarea 
                      className="w-full border border-slate-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 outline-none"
                      rows="3"
                      value={newRequestData.reason}
                      onChange={e => setNewRequestData({...newRequestData, reason: e.target.value})}
                      placeholder="פרט את הצורך העסקי..."
                      required
                   ></textarea>
                </div>
                <div className="flex gap-2 justify-end mt-6">
                   <button 
                      type="button" 
                      onClick={() => setShowRequestModal(false)}
                      className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg"
                   >
                     ביטול
                   </button>
                   <button 
                      type="submit" 
                      className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                   >
                     שלח בקשה
                   </button>
                </div>
             </form>
          </div>
        </div>
      )}
    </div>
  );
};

// 4. Data Catalog Module
const DataCatalog = ({ currentUser }) => { 
  const [search, setSearch] = useState('');
  const [classificationFilter, setClassificationFilter] = useState('all');
  const [typeFilter, setTypeFilter] = useState('all');
  const [expandedId, setExpandedId] = useState(null);

  const allClassifications = ['all', ...new Set(MOCK_DATA_CATALOG.map(i => i.classification))];
  const allTypes = ['all', ...new Set(MOCK_DATA_CATALOG.map(i => i.type))];

  const filteredData = MOCK_DATA_CATALOG.filter(item => {
    const matchesSearch = item.name.includes(search) || 
                          item.owner.includes(search) || 
                          (item.tags && item.tags.some(t => t.includes(search)));
    const matchesClass = classificationFilter === 'all' || item.classification === classificationFilter;
    const matchesType = typeFilter === 'all' || item.type === typeFilter;
    
    return matchesSearch && matchesClass && matchesType;
  });

  const checkDownloadPermission = (item) => {
    if (!currentUser) return false;
    if (currentUser.role === 'admin') return true;
    if (item.classification === 'ציבורי') return true;
    if (currentUser.department === item.department) return true;
    return false;
  };

  const handleDownload = (item) => {
    if (checkDownloadPermission(item)) {
      alert(`מתחיל הורדה: ${item.name}\nגודל: ${item.size}\nפורמט: ${item.type}`);
    } else {
      alert('אין לך הרשאות להורדת קובץ זה. אנא פנה לבעלי הדאטה.');
    }
  };

  const toggleExpand = (id) => {
    setExpandedId(expandedId === id ? null : id);
  };

  return (
    <div className="max-w-7xl mx-auto px-4 py-8 animate-fade-in">
      <header className="mb-8">
        <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
          <div>
            <h2 className="text-3xl font-bold text-slate-800 flex items-center gap-2">
              <Database className="text-blue-600" />
              קטלוג דאטה פנימי
            </h2>
            <p className="text-slate-500">אינדקס נתונים ארגוני - חיפוש, סינון וניהול מידע</p>
          </div>
          <div className="relative w-full md:w-80">
            <input 
              type="text" 
              placeholder="חיפוש חופשי (שם, בעלים, תגיות)..." 
              className="pl-4 pr-10 py-3 border border-slate-300 rounded-xl w-full focus:ring-2 focus:ring-blue-500 outline-none shadow-sm"
              value={search}
              onChange={(e) => setSearch(e.target.value)}
              aria-label="חיפוש בקטלוג"
            />
            <Search className="absolute top-3.5 right-3 text-slate-400" size={18} />
          </div>
        </div>

        <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex flex-col md:flex-row gap-4 items-center">
          <div className="flex items-center gap-2 text-slate-700 font-semibold text-sm">
            <Filter size={16} /> סינון מתקדם:
          </div>
          <div className="flex items-center gap-2 w-full md:w-auto">
            <span className="text-xs text-slate-500 whitespace-nowrap">סיווג:</span>
            <select 
              value={classificationFilter} 
              onChange={(e) => setClassificationFilter(e.target.value)}
              className="bg-slate-50 border border-slate-200 rounded-lg px-3 py-1.5 text-sm w-full md:w-40 focus:outline-none focus:border-blue-500"
            >
              <option value="all">הכל</option>
              {allClassifications.filter(c => c !== 'all').map(c => <option key={c} value={c}>{c}</option>)}
            </select>
          </div>
          <div className="flex items-center gap-2 w-full md:w-auto">
            <span className="text-xs text-slate-500 whitespace-nowrap">סוג קובץ:</span>
            <select 
              value={typeFilter} 
              onChange={(e) => setTypeFilter(e.target.value)}
              className="bg-slate-50 border border-slate-200 rounded-lg px-3 py-1.5 text-sm w-full md:w-40 focus:outline-none focus:border-blue-500"
            >
              <option value="all">הכל</option>
              {allTypes.filter(t => t !== 'all').map(t => <option key={t} value={t}>{t}</option>)}
            </select>
          </div>
          <div className="flex-grow"></div>
          <div className="text-xs text-slate-400">
            נמצאו {filteredData.length} תוצאות
          </div>
        </div>
      </header>

      <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
        <div className="overflow-x-auto">
          <table className="w-full text-right" aria-label="טבלת קטלוג נתונים">
            <thead className="bg-slate-50 text-slate-600 font-semibold text-sm border-b border-slate-200">
              <tr>
                <th className="p-4 w-10"></th>
                <th className="p-4">שם המאגר</th>
                <th className="p-4">תגיות</th>
                <th className="p-4 hidden md:table-cell">בעלים</th>
                <th className="p-4">סיווג</th>
                <th className="p-4">פעולות</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-slate-100">
              {filteredData.map((item) => {
                const isExpanded = expandedId === item.id;
                const canDownload = checkDownloadPermission(item);

                return (
                  <React.Fragment key={item.id}>
                    <tr 
                      className={`hover:bg-slate-50 transition cursor-pointer ${isExpanded ? 'bg-blue-50/50' : ''}`}
                      onClick={() => toggleExpand(item.id)}
                    >
                      <td className="p-4 text-slate-400">
                        {isExpanded ? <ChevronUp size={18} /> : <ChevronDown size={18} />}
                      </td>
                      <td className="p-4">
                        <div className="font-bold text-slate-800 flex items-center gap-2">
                          <FileSpreadsheet size={16} className="text-blue-500" />
                          {item.name}
                        </div>
                        <div className="text-xs text-slate-500 md:hidden mt-1">{item.owner}</div>
                      </td>
                      <td className="p-4">
                        <div className="flex flex-wrap gap-1">
                          {item.tags?.map(tag => (
                            <span key={tag} className="text-[10px] bg-slate-100 px-2 py-0.5 rounded text-slate-600 border border-slate-200 flex items-center gap-1">
                              <Tag size={10} /> {tag}
                            </span>
                          ))}
                        </div>
                      </td>
                      <td className="p-4 text-slate-600 hidden md:table-cell">{item.owner}</td>
                      <td className="p-4">
                        <span className={`px-2 py-1 rounded-full text-xs font-semibold
                          ${item.classification === 'סודי ביותר' ? 'bg-red-100 text-red-700' : 
                            item.classification === 'סודי' ? 'bg-orange-100 text-orange-700' :
                            item.classification === 'פנימי' ? 'bg-blue-100 text-blue-700' :
                            'bg-green-100 text-green-700'}`}>
                          {item.classification}
                        </span>
                      </td>
                      <td className="p-4">
                        <button 
                          onClick={(e) => {
                            e.stopPropagation();
                            handleDownload(item);
                          }}
                          className={`flex items-center gap-1 text-sm font-medium px-3 py-1.5 rounded transition
                            ${canDownload 
                              ? 'text-blue-600 hover:bg-blue-100' 
                              : 'text-slate-400 cursor-not-allowed'}`}
                          title={canDownload ? 'הורד קובץ' : 'אין הרשאה להורדה'}
                        >
                          {canDownload ? <Download size={16} /> : <Lock size={16} />}
                          <span className="hidden sm:inline">הורדה</span>
                        </button>
                      </td>
                    </tr>
                    
                    {isExpanded && (
                      <tr className="bg-slate-50/50 border-b border-slate-100">
                        <td colSpan="6" className="p-0">
                          <div className="p-6 grid md:grid-cols-3 gap-6 animate-fade-in cursor-default" onClick={(e) => e.stopPropagation()}>
                            <div className="space-y-4">
                              <h4 className="font-bold text-slate-700 text-sm border-b pb-2">מטא-דאטה</h4>
                              <div className="grid grid-cols-2 gap-y-2 text-sm">
                                <span className="text-slate-500">גודל:</span>
                                <span className="font-mono font-bold text-slate-700">{item.size}</span>
                                <span className="text-slate-500">פורמט:</span>
                                <span>{item.type}</span>
                                <span className="text-slate-500">עודכן:</span>
                                <span>{item.lastUpdate}</span>
                                <span className="text-slate-500">מחלקה:</span>
                                <span>{item.department}</span>
                              </div>
                              <div className="pt-2">
                                <button className="text-blue-600 text-xs hover:underline flex items-center gap-1">
                                  <ExternalLink size={12} /> צפה במילון נתונים מלא
                                </button>
                              </div>
                            </div>
                            <div className="md:col-span-2 bg-white rounded-lg border border-slate-200 p-4">
                              <h4 className="font-bold text-slate-700 text-sm mb-4 flex items-center gap-2">
                                <Activity size={16} className="text-blue-500" /> 
                                איכות ושימוש (Visual Preview)
                              </h4>
                              <div className="flex items-center gap-8 mb-6">
                                <div className="text-center">
                                  <div className="relative w-16 h-16 rounded-full border-4 border-slate-100 flex items-center justify-center mx-auto mb-2">
                                    <div className="absolute inset-0 border-4 border-green-500 rounded-full border-l-transparent border-b-transparent transform -rotate-45"></div>
                                    <span className="font-bold text-lg text-slate-700">{item.qualityScore}%</span>
                                  </div>
                                  <span className="text-xs text-slate-500">ציון איכות</span>
                                </div>
                                <div className="flex-grow">
                                  <div className="flex items-end justify-between h-16 gap-1 mb-1">
                                    {[30, 45, 20, 60, 75, 50, 80].map((h, i) => (
                                      <div key={i} className="w-full bg-blue-100 rounded-t-sm" style={{height: `${h}%`}}></div>
                                    ))}
                                  </div>
                                  <div className="text-center text-xs text-slate-400 border-t pt-1">מגמת שימוש (7 ימים)</div>
                                </div>
                              </div>
                              <div className="bg-slate-50 p-3 rounded text-xs text-slate-600 border border-slate-100">
                                <div className="flex gap-2 mb-1">
                                  <CheckSquare size={14} className="text-green-500" />
                                  <span>נתונים מאומתים ע"י Data Steward</span>
                                </div>
                                <div className="flex gap-2">
                                  <ShieldCheck size={14} className="text-blue-500" />
                                  <span>תואם תקן פרטיות (GDPR)</span>
                                </div>
                              </div>
                            </div>
                          </div>
                        </td>
                      </tr>
                    )}
                  </React.Fragment>
                );
              })}
            </tbody>
          </table>
        </div>
        {filteredData.length === 0 && (
          <div className="p-12 text-center">
            <Database className="mx-auto h-12 w-12 text-slate-300 mb-3" />
            <h3 className="text-lg font-medium text-slate-900">לא נמצאו נתונים</h3>
            <p className="text-slate-500">נסה לשנות את מסנני החיפוש או הסיווג.</p>
          </div>
        )}
      </div>
    </div>
  );
};

// 5. Supplier Portal Module
const SupplierPortal = ({ user }) => {
  const [activeTab, setActiveTab] = useState('orders');
  const [supplierFiles, setSupplierFiles] = useState([
    { id: 1, name: 'invoice_march_24.pdf', version: 1, status: 'validated', date: '2024-03-10', logs: ['File uploaded successfully'] }
  ]);
  const [isUploading, setIsUploading] = useState(false);
  const [uploadStatus, setUploadStatus] = useState(null);

  const handleFileUpload = (event) => {
    const file = event.target.files[0];
    if (!file) return;

    setUploadStatus(null);
    setIsUploading(true);

    const allowedExtensions = ['pdf', 'csv', 'xlsx', 'json'];
    const fileExt = file.name.split('.').pop().toLowerCase();
    
    if (!allowedExtensions.includes(fileExt)) {
      setUploadStatus({ type: 'error', message: 'שגיאה: סוג קובץ לא נתמך. מותרים רק: PDF, CSV, XLSX, JSON.' });
      setIsUploading(false);
      alert('התראה אוטומטית: ניסיון העלאת קובץ לא תקין נרשם במערכת.');
      return;
    }

    setTimeout(() => {
      const isValid = Math.random() > 0.3; 
      
      if (isValid) {
        setSupplierFiles(prev => {
          const existingIndex = prev.findIndex(f => f.name === file.name);
          if (existingIndex >= 0) {
             const updated = [...prev];
             updated[existingIndex] = {
               ...updated[existingIndex],
               version: updated[existingIndex].version + 1,
               date: new Date().toLocaleDateString('en-CA'),
               logs: [...updated[existingIndex].logs, `Version ${updated[existingIndex].version + 1} uploaded`]
             };
             return updated;
          } else {
            return [{
              id: Date.now(),
              name: file.name,
              version: 1,
              status: 'validated',
              date: new Date().toLocaleDateString('en-CA'),
              logs: ['File created and validated']
            }, ...prev];
          }
        });
        setUploadStatus({ type: 'success', message: 'הקובץ עבר בדיקת תקינות ונשמר בהצלחה.' });
      } else {
        setUploadStatus({ type: 'error', message: 'שגיאת ולידציה: מבנה הקובץ אינו תקין (Missing Headers).' });
        alert('הודעה נשלחה למייל הספק: נכשל עיבוד קובץ עקב מבנה שגוי.');
      }
      setIsUploading(false);
    }, 2000);
  };

  return (
    <div className="max-w-7xl mx-auto px-4 py-8 animate-fade-in">
      <header className="mb-8 bg-blue-50 p-6 rounded-xl border border-blue-100 flex items-start gap-4">
        <div className="bg-blue-600 p-3 rounded-lg text-white">
          <Truck size={32} />
        </div>
        <div>
          <h2 className="text-2xl font-bold text-blue-900">פורטל ספקים - {user.name}</h2>
          <p className="text-blue-700 mt-1">
            גישה מאובטחת להזמנות, חשבוניות וסטטוס תשלומים.
            <br />
            <span className="text-xs opacity-75 flex items-center gap-1 mt-2">
              <Lock size={12} /> תקשורת מוצפנת (TLS 1.3)
            </span>
          </p>
        </div>
      </header>

      <div className="flex gap-4 mb-6 border-b border-slate-200">
        <button 
          onClick={() => setActiveTab('orders')}
          className={`pb-2 px-4 font-medium transition ${activeTab === 'orders' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-slate-500 hover:text-slate-700'}`}
        >
          הזמנות רכש
        </button>
        <button 
          onClick={() => setActiveTab('files')}
          className={`pb-2 px-4 font-medium transition ${activeTab === 'files' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-slate-500 hover:text-slate-700'}`}
        >
          ניהול קבצים וחשבוניות
        </button>
      </div>

      {activeTab === 'orders' && (
        <div className="animate-fade-in">
          <h3 className="text-xl font-bold mb-4 text-slate-800">הזמנות רכש אחרונות</h3>
          <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <table className="w-full text-right">
              <thead className="bg-slate-50 text-slate-600 font-semibold text-sm">
                <tr>
                  <th className="p-4">מספר הזמנה</th>
                  <th className="p-4">תאריך</th>
                  <th className="p-4">סכום</th>
                  <th className="p-4">סטטוס</th>
                  <th className="p-4">מסמכים</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-slate-100">
                {MOCK_SUPPLIER_ORDERS.map((order) => (
                  <tr key={order.id} className="hover:bg-slate-50 transition">
                    <td className="p-4 font-mono text-slate-700">{order.id}</td>
                    <td className="p-4 text-slate-600">{order.date}</td>
                    <td className="p-4 font-bold text-slate-800">{order.amount}</td>
                    <td className="p-4">
                      <span className={`px-2 py-1 rounded-full text-xs font-semibold
                        ${order.status === 'אושר' ? 'bg-green-100 text-green-700' : 
                          order.status === 'בטיפול' ? 'bg-yellow-100 text-yellow-700' :
                          'bg-blue-100 text-blue-700'}`}>
                        {order.status}
                      </span>
                    </td>
                    <td className="p-4">
                      <button className="flex items-center gap-1 text-slate-500 hover:text-blue-600 transition">
                        <FileText size={16} />
                        <span className="text-sm">צפה בחשבונית</span>
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {activeTab === 'files' && (
        <div className="animate-fade-in space-y-6">
          <div className="bg-white p-6 rounded-xl border border-dashed border-slate-300 text-center hover:bg-slate-50 transition relative">
             <input 
                type="file" 
                onChange={handleFileUpload} 
                className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                disabled={isUploading}
             />
             <div className="flex flex-col items-center gap-2">
                <div className="bg-blue-100 p-3 rounded-full text-blue-600">
                  {isUploading ? <RefreshCw className="animate-spin" size={24} /> : <Upload size={24} />}
                </div>
                <h4 className="font-bold text-slate-700">
                  {isUploading ? 'מעבד קובץ...' : 'לחץ או גרור קבצים להעלאה'}
                </h4>
                <p className="text-sm text-slate-500">
                  תמיכה ב-PDF, CSV, Excel, JSON. בדיקת תקינות אוטומטית לפני שמירה.
                </p>
             </div>
          </div>

          {uploadStatus && (
            <div className={`p-4 rounded-lg flex items-start gap-3 ${uploadStatus.type === 'error' ? 'bg-red-50 text-red-700 border border-red-200' : 'bg-green-50 text-green-700 border border-green-200'}`}>
               {uploadStatus.type === 'error' ? <AlertCircle size={20} /> : <CheckCircle size={20} />}
               <div>
                 <p className="font-bold">{uploadStatus.type === 'error' ? 'שגיאה בהעלאה' : 'העלאה הושלמה'}</p>
                 <p className="text-sm">{uploadStatus.message}</p>
               </div>
            </div>
          )}

          <div className="bg-white rounded-xl shadow-sm border border-slate-200">
            <div className="p-4 border-b border-slate-100 bg-slate-50 rounded-t-xl font-bold text-slate-700">
              מאגר קבצים וגרסאות
            </div>
            <div className="divide-y divide-slate-100">
              {supplierFiles.map(file => (
                <div key={file.id} className="p-4 flex items-center justify-between hover:bg-slate-50">
                   <div className="flex items-center gap-3">
                      <FileJson className="text-slate-400" size={20} />
                      <div>
                        <div className="font-medium text-slate-800">{file.name}</div>
                        <div className="text-xs text-slate-500 flex gap-2">
                          <span>גרסה {file.version}.0</span>
                          <span>•</span>
                          <span>{file.date}</span>
                        </div>
                      </div>
                   </div>
                   <div className="flex items-center gap-4">
                      <span className="bg-green-100 text-green-700 text-xs px-2 py-1 rounded-full font-bold flex items-center gap-1">
                        <CheckCircle size={10} /> תקין
                      </span>
                      <button 
                        className="text-blue-600 text-sm hover:underline"
                        onClick={() => alert(`לוג היסטורי עבור ${file.name}:\n${file.logs.join('\n')}`)}
                      >
                        צפה בלוג
                      </button>
                   </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// 6. Permissions Management Module (Admin)
const PermissionsModule = ({ requests, onRequestUpdate }) => {
  const pendingRequests = requests.filter(r => r.status === 'pending');
  const historyRequests = requests.filter(r => r.status !== 'pending');

  const handleAction = (request, status) => {
    const adminNote = status === 'approved' ? 'אושר ע"י Admin' : 'נדחה ע"י Admin';
    onRequestUpdate(request.id, status, adminNote);
  };

  return (
    <div className="max-w-7xl mx-auto px-4 py-8 animate-fade-in">
      <header className="mb-8">
        <h2 className="text-3xl font-bold text-slate-800 flex items-center gap-2">
          <Settings className="text-slate-800" />
          ניהול הרשאות ובקשות גישה
        </h2>
        <p className="text-slate-500">מודול ניהול גישה מרכזי (Identity Management)</p>
      </header>

      <div className="grid md:grid-cols-3 gap-6 mb-8">
        <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
          <h4 className="font-bold text-slate-700 mb-2">בקשות בהמתנה</h4>
          <div className="flex items-center justify-between">
             <div className="text-4xl font-bold text-orange-500">{pendingRequests.length}</div>
             <div className="bg-orange-100 p-3 rounded-full text-orange-600"><Clock size={24} /></div>
          </div>
          <div className="text-xs text-slate-500 mt-2">נדרש טיפול מיידי</div>
        </div>
        <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
          <h4 className="font-bold text-slate-700 mb-2">משתמשים פעילים</h4>
          <div className="flex items-center justify-between">
             <div className="text-4xl font-bold text-blue-600">1,245</div>
             <div className="bg-blue-100 p-3 rounded-full text-blue-600"><Users size={24} /></div>
          </div>
          <div className="text-xs text-slate-500 mt-2">עודכן לפני 2 דקות</div>
        </div>
        <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
          <h4 className="font-bold text-slate-700 mb-2">התראות אבטחה</h4>
          <div className="flex items-center justify-between">
            <div className="text-4xl font-bold text-red-600">3</div>
            <div className="bg-red-100 p-3 rounded-full text-red-600"><AlertTriangle size={24} /></div>
          </div>
           <div className="text-xs text-slate-500 mt-2">ניסיונות גישה חריגים</div>
        </div>
      </div>

      <div className="grid md:grid-cols-3 gap-8">
         <div className="md:col-span-2 bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div className="p-4 border-b border-slate-100 bg-orange-50 rounded-t-xl flex justify-between items-center">
              <h3 className="font-bold text-slate-700 flex items-center gap-2">
                <Clock size={18} /> תור בקשות לטיפול
              </h3>
              <span className="text-xs bg-white px-2 py-1 rounded border border-slate-200 text-slate-500">
                ממתינות: {pendingRequests.length}
              </span>
            </div>
            
            <div className="divide-y divide-slate-100">
              {pendingRequests.length === 0 && (
                <div className="p-8 text-center text-slate-500">אין בקשות גישה הממתינות לטיפול.</div>
              )}
              {pendingRequests.map((req) => (
                <div key={req.id} className="p-5 hover:bg-slate-50 transition">
                   <div className="flex justify-between items-start mb-3">
                      <div>
                        <div className="font-bold text-lg text-slate-800 flex items-center gap-2">
                           <UserCheck size={18} className="text-blue-500" />
                           {req.userName}
                        </div>
                        <div className="text-sm text-slate-500">מבקש גישה למשאב: <span className="font-semibold text-slate-700">{req.resource}</span></div>
                      </div>
                      <div className="text-xs text-slate-400 bg-slate-100 px-2 py-1 rounded">{req.date}</div>
                   </div>
                   <div className="bg-yellow-50 p-3 rounded border border-yellow-100 text-sm text-slate-700 mb-4">
                      <span className="font-bold">סיבה:</span> {req.reason}
                   </div>
                   <div className="flex gap-3 justify-end">
                      <button 
                        onClick={() => handleAction(req, 'rejected')}
                        className="px-4 py-2 border border-red-200 text-red-600 rounded-lg hover:bg-red-50 text-sm font-medium flex items-center gap-1"
                      >
                        <X size={16} /> דחה בקשה
                      </button>
                      <button 
                        onClick={() => handleAction(req, 'approved')}
                        className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm font-medium flex items-center gap-1 shadow-sm"
                      >
                        <CheckCircle size={16} /> אשר בקשה
                      </button>
                   </div>
                </div>
              ))}
            </div>
         </div>

         <div className="space-y-6">
            <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
               <div className="p-4 border-b border-slate-100 bg-slate-50 rounded-t-xl">
                 <h3 className="font-bold text-slate-700 text-sm">היסטוריית בקשות אחרונות</h3>
               </div>
               <div className="max-h-[400px] overflow-y-auto p-4 space-y-3">
                  {historyRequests.slice(0, 5).map(req => (
                    <div key={req.id} className="text-sm border-b border-slate-50 pb-2 last:border-0">
                       <div className="flex justify-between font-medium">
                          <span>{req.userName}</span>
                          <span className={req.status === 'approved' ? 'text-green-600' : 'text-red-600'}>
                             {req.status === 'approved' ? 'אושר' : 'נדחה'}
                          </span>
                       </div>
                       <div className="text-xs text-slate-500 truncate">{req.resource}</div>
                       <div className="text-[10px] text-slate-400 mt-1">{req.log[req.log.length-1]}</div>
                    </div>
                  ))}
                  {historyRequests.length === 0 && <p className="text-xs text-slate-400 text-center">אין היסטוריה זמינה.</p>}
               </div>
            </div>

            <div className="bg-white rounded-xl shadow-sm border border-slate-200">
               <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-xl">
                 <h3 className="font-bold text-slate-700 text-sm">ניהול משתמשים מהיר</h3>
               </div>
               <table className="w-full text-right text-sm">
                 <tbody className="divide-y divide-slate-100">
                   {MOCK_USERS.map((u) => (
                     <tr key={u.id} className="hover:bg-slate-50">
                       <td className="p-3 font-medium text-slate-800">{u.name}</td>
                       <td className="p-3">
                         <span className="bg-slate-100 px-2 py-0.5 rounded text-[10px] border border-slate-200 font-mono">
                           {u.role}
                         </span>
                       </td>
                       <td className="p-3 text-center">
                         <button className="text-slate-400 hover:text-blue-600"><Settings size={14}/></button>
                       </td>
                     </tr>
                   ))}
                 </tbody>
               </table>
            </div>
         </div>
      </div>
    </div>
  );
};

// --- NEW MODULE: System Workflow Visualization ---
const SystemWorkflow = () => {
  const [activeFlow, setActiveFlow] = useState('entry');

  const WorkflowNode = ({ icon: Icon, label, color = 'bg-white', textColor = 'text-slate-700' }) => (
    <div className={`flex flex-col items-center p-4 rounded-xl border-2 border-slate-200 shadow-sm ${color} w-40 text-center z-10 transition hover:scale-105`}>
      <Icon className={`mb-2 ${textColor}`} size={24} />
      <span className={`text-sm font-bold ${textColor}`}>{label}</span>
    </div>
  );

  const Arrow = ({ label }) => (
    <div className="flex-grow flex flex-col items-center justify-center px-2 relative min-w-[50px]">
      {label && <span className="text-[10px] text-slate-500 mb-1 bg-white px-1 relative z-20">{label}</span>}
      <div className="w-full h-0.5 bg-slate-300 relative">
        <div className="absolute left-0 -top-1.5 text-slate-300">◄</div>
      </div>
    </div>
  );

  const renderFlow = () => {
    switch (activeFlow) {
      case 'entry':
        return (
          <div className="flex flex-col gap-8 items-center justify-center h-full py-10">
            <h3 className="text-xl font-bold text-slate-700 mb-4">תהליך כניסה וזיהוי (User Entry Flow)</h3>
            <div className="flex items-center w-full max-w-4xl justify-between">
              <WorkflowNode icon={Server} label="דף נחיתה ציבורי" />
              <Arrow label="לחיצה על התחברות" />
              <WorkflowNode icon={LogIn} label="מסך התחברות" color="bg-blue-50" textColor="text-blue-700" />
              <Arrow label="בחירת תפקיד" />
              <WorkflowNode icon={Users} label="זיהוי משתמש" />
            </div>
            <div className="grid grid-cols-3 gap-4 mt-8 w-full max-w-4xl">
              <div className="text-center p-4 bg-slate-50 rounded border border-slate-200">
                <span className="font-bold block mb-1">אורח</span>
                <span className="text-xs text-slate-500">גישה לדשבורדים ציבוריים בלבד</span>
              </div>
              <div className="text-center p-4 bg-slate-50 rounded border border-slate-200">
                <span className="font-bold block mb-1">עובד/מנהל</span>
                <span className="text-xs text-slate-500">גישה מלאה (בכפוף להרשאות)</span>
              </div>
              <div className="text-center p-4 bg-slate-50 rounded border border-slate-200">
                <span className="font-bold block mb-1">ספק</span>
                <span className="text-xs text-slate-500">גישה לפורטל ספקים בלבד</span>
              </div>
            </div>
          </div>
        );
      case 'auth':
        return (
          <div className="flex flex-col gap-8 items-center justify-center h-full py-10">
            <h3 className="text-xl font-bold text-slate-700 mb-4">אימות והרשאות (Auth & Permissions)</h3>
            <div className="flex items-center w-full max-w-5xl justify-between">
              <WorkflowNode icon={Fingerprint} label="משתמש מאומת" color="bg-green-50" textColor="text-green-700" />
              <Arrow label="בקשת גישה למודול" />
              <WorkflowNode icon={ShieldCheck} label="בדיקת תפקיד (Role Guard)" />
              <Arrow label="אימות" />
              <div className="flex flex-col gap-4">
                 <div className="flex items-center gap-2">
                    <div className="w-4 h-0.5 bg-slate-300"></div>
                    <div className="p-2 border rounded bg-white text-xs w-32 text-center">הצלחה: הצג תוכן</div>
                 </div>
                 <div className="flex items-center gap-2">
                    <div className="w-4 h-0.5 bg-slate-300"></div>
                    <div className="p-2 border rounded bg-red-50 text-red-600 text-xs w-32 text-center">כישלון: גישה נדחתה</div>
                 </div>
              </div>
            </div>
          </div>
        );
      case 'display':
        return (
          <div className="flex flex-col gap-8 items-center justify-center h-full py-10">
             <h3 className="text-xl font-bold text-slate-700 mb-4">הצגת תוכן ומשאבים (Content Display)</h3>
             <div className="grid grid-cols-1 md:grid-cols-3 gap-8 w-full max-w-5xl">
                <div className="border border-slate-200 p-4 rounded-xl flex flex-col items-center text-center">
                   <BarChart2 className="text-blue-500 mb-2" />
                   <h4 className="font-bold">דשבורדים</h4>
                   <Arrow label="בדיקת רגישות" />
                   <div className="text-xs mt-2 bg-slate-50 p-2 rounded w-full">
                     אם רגיש {'->'} דרוש GovID
                   </div>
                </div>
                <div className="border border-slate-200 p-4 rounded-xl flex flex-col items-center text-center">
                   <Database className="text-purple-500 mb-2" />
                   <h4 className="font-bold">קטלוג דאטה</h4>
                   <Arrow label="סינון שורות" />
                   <div className="text-xs mt-2 bg-slate-50 p-2 rounded w-full">
                     הצגה לפי מחלקה/סיווג
                   </div>
                </div>
                <div className="border border-slate-200 p-4 rounded-xl flex flex-col items-center text-center">
                   <Truck className="text-orange-500 mb-2" />
                   <h4 className="font-bold">פורטל ספקים</h4>
                   <Arrow label="בדיקת קבצים" />
                   <div className="text-xs mt-2 bg-slate-50 p-2 rounded w-full">
                     ולידציה אוטומטית לקבצים
                   </div>
                </div>
             </div>
          </div>
        );
      case 'requests':
        return (
          <div className="flex flex-col gap-8 items-center justify-center h-full py-10">
            <h3 className="text-xl font-bold text-slate-700 mb-4">טיפול בבקשות גישה (Access Request Loop)</h3>
            <div className="flex flex-col md:flex-row items-center w-full max-w-5xl justify-between gap-4">
              <WorkflowNode icon={UserX} label="גישה נדחתה" color="bg-red-50" textColor="text-red-700" />
              <Arrow label="הגשת בקשה" />
              <WorkflowNode icon={Database} label="שמירה ב-DB (סטטוס: ממתין)" />
              <Arrow label="התראה למנהל" />
              <WorkflowNode icon={Settings} label="מסך ניהול (Admin)" color="bg-slate-800" textColor="text-white" />
            </div>
            <div className="w-full h-0.5 bg-slate-200 my-4 relative">
               <div className="absolute top-0 left-1/2 -translate-x-1/2 bg-white px-2 text-xs text-slate-400 -mt-2">פעולת מנהל</div>
            </div>
            <div className="flex justify-center gap-16 w-full">
               <div className="flex flex-col items-center">
                  <div className="h-8 w-0.5 bg-green-300 mb-2"></div>
                  <div className="p-3 bg-green-50 text-green-700 border border-green-200 rounded-lg text-sm font-bold">אישור</div>
                  <div className="text-xs text-slate-500 mt-1">עדכון הרשאות + הודעה</div>
               </div>
               <div className="flex flex-col items-center">
                  <div className="h-8 w-0.5 bg-red-300 mb-2"></div>
                  <div className="p-3 bg-red-50 text-red-700 border border-red-200 rounded-lg text-sm font-bold">דחייה</div>
                  <div className="text-xs text-slate-500 mt-1">עדכון סטטוס + הודעה</div>
               </div>
            </div>
          </div>
        );
      default: return null;
    }
  };

  return (
    <div className="max-w-7xl mx-auto px-4 py-8 animate-fade-in">
      <header className="mb-8">
        <h2 className="text-3xl font-bold text-slate-800 flex items-center gap-2">
          <GitBranch className="text-slate-800" />
          תרשים זרימת מערכת (Workflow Visualization)
        </h2>
        <p className="text-slate-500">מיפוי ויזואלי של התהליכים העסקיים, ההרשאות וזרימת המידע במערכת.</p>
      </header>

      <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden min-h-[600px] flex flex-col">
        {/* Workflow Navigation Tabs */}
        <div className="flex border-b border-slate-200 bg-slate-50 overflow-x-auto">
          <button 
            onClick={() => setActiveFlow('entry')}
            className={`px-6 py-4 font-medium text-sm whitespace-nowrap transition-colors flex items-center gap-2
              ${activeFlow === 'entry' ? 'bg-white border-t-2 border-t-blue-600 text-blue-600' : 'text-slate-500 hover:bg-slate-100'}`}
          >
            <LogIn size={16} /> 1. כניסה וזיהוי
          </button>
          <button 
            onClick={() => setActiveFlow('auth')}
            className={`px-6 py-4 font-medium text-sm whitespace-nowrap transition-colors flex items-center gap-2
              ${activeFlow === 'auth' ? 'bg-white border-t-2 border-t-blue-600 text-blue-600' : 'text-slate-500 hover:bg-slate-100'}`}
          >
            <ShieldCheck size={16} /> 2. אימות והרשאות
          </button>
          <button 
            onClick={() => setActiveFlow('display')}
            className={`px-6 py-4 font-medium text-sm whitespace-nowrap transition-colors flex items-center gap-2
              ${activeFlow === 'display' ? 'bg-white border-t-2 border-t-blue-600 text-blue-600' : 'text-slate-500 hover:bg-slate-100'}`}
          >
            <Server size={16} /> 3. הצגת משאבים
          </button>
          <button 
            onClick={() => setActiveFlow('requests')}
            className={`px-6 py-4 font-medium text-sm whitespace-nowrap transition-colors flex items-center gap-2
              ${activeFlow === 'requests' ? 'bg-white border-t-2 border-t-blue-600 text-blue-600' : 'text-slate-500 hover:bg-slate-100'}`}
          >
            <MessageSquare size={16} /> 4. ניהול בקשות גישה
          </button>
        </div>

        {/* Visualization Area */}
        <div className="flex-grow bg-slate-50/50 p-8 relative">
           {/* Background Grid Pattern */}
           <div className="absolute inset-0 opacity-[0.03] pointer-events-none" 
                style={{ backgroundImage: 'radial-gradient(#475569 1px, transparent 1px)', backgroundSize: '20px 20px' }}>
           </div>
           
           {renderFlow()}
        </div>
      </div>
    </div>
  );
};

// 7. Login / Role Selection (Simulation)
const LoginScreen = ({ onLogin }) => {
  return (
    <div className="flex flex-col items-center justify-center min-h-[60vh] p-4 animate-fade-in">
      <div className="bg-white p-8 rounded-2xl shadow-xl border border-slate-100 max-w-md w-full text-center">
        <div className="bg-blue-100 p-4 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-6">
          <Lock className="text-blue-600" size={32} />
        </div>
        <h2 className="text-2xl font-bold mb-2 text-slate-800">התחברות למערכת</h2>
        <p className="text-slate-500 mb-8">בחר פרופיל להדגמת הרשאות המערכת</p>
        
        <div className="space-y-3">
          <button 
            onClick={() => onLogin({ id: 1, name: 'ישראל ישראלי', role: ROLES.EMPLOYEE, department: 'finance' })}
            className="w-full p-4 border rounded-xl hover:bg-blue-50 hover:border-blue-200 transition flex items-center justify-between group"
          >
            <div className="flex items-center gap-3">
              <Users className="text-slate-400 group-hover:text-blue-500" />
              <div className="text-right">
                <div className="font-bold text-slate-700">עובד חברה (כספים)</div>
                <div className="text-xs text-slate-500">גישה לאזור אישי וקטלוג</div>
              </div>
            </div>
            <div className="w-2 h-2 rounded-full bg-slate-200 group-hover:bg-blue-500"></div>
          </button>

          <button 
            onClick={() => onLogin({ id: 2, name: 'ספקים פלוס בע"מ', role: ROLES.SUPPLIER, department: 'external' })}
            className="w-full p-4 border rounded-xl hover:bg-blue-50 hover:border-blue-200 transition flex items-center justify-between group"
          >
            <div className="flex items-center gap-3">
              <Truck className="text-slate-400 group-hover:text-blue-500" />
              <div className="text-right">
                <div className="font-bold text-slate-700">ספק חיצוני</div>
                <div className="text-xs text-slate-500">גישה לפורטל ספקים בלבד</div>
              </div>
            </div>
            <div className="w-2 h-2 rounded-full bg-slate-200 group-hover:bg-blue-500"></div>
          </button>

          <button 
            onClick={() => onLogin({ id: 3, name: 'Admin User', role: ROLES.ADMIN, department: 'it' })}
            className="w-full p-4 border rounded-xl hover:bg-blue-50 hover:border-blue-200 transition flex items-center justify-between group"
          >
            <div className="flex items-center gap-3">
              <Shield className="text-slate-400 group-hover:text-blue-500" />
              <div className="text-right">
                <div className="font-bold text-slate-700">מנהל מערכת</div>
                <div className="text-xs text-slate-500">גישה מלאה לכל המודולים</div>
              </div>
            </div>
            <div className="w-2 h-2 rounded-full bg-slate-200 group-hover:bg-blue-500"></div>
          </button>
        </div>
      </div>
      <p className="mt-8 text-xs text-slate-400 flex items-center gap-1">
        <Lock size={10} /> המערכת מאובטחת ומוצפנת מקצה לקצה
      </p>
    </div>
  );
};

// 8. Access Denied Component
const AccessDenied = () => (
  <div className="flex flex-col items-center justify-center min-h-[50vh] text-center p-4">
    <div className="bg-red-100 p-4 rounded-full mb-4">
      <Lock className="text-red-600" size={32} />
    </div>
    <h2 className="text-2xl font-bold text-slate-800 mb-2">גישה נדחתה</h2>
    <p className="text-slate-600 max-w-md">
      אין לך הרשאות מתאימות לצפייה במודול זה. אנא פנה למנהל המערכת או התחבר עם משתמש אחר.
    </p>
  </div>
);

// --- Main App Component ---

const App = () => {
  const [currentUser, setCurrentUser] = useState(null);
  const [currentView, setCurrentView] = useState('public');
  // State for Access Requests (Shared between User and Admin)
  const [accessRequests, setAccessRequests] = useState(MOCK_ACCESS_REQUESTS);

  // Function to handle new request submission
  const handleNewRequest = (requestData) => {
    const newReq = {
      id: Date.now(),
      userId: requestData.userId,
      userName: requestData.userName,
      resource: requestData.resource,
      reason: requestData.reason,
      status: 'pending',
      date: new Date().toLocaleDateString('en-CA'),
      log: ['בקשה הוגשה']
    };
    setAccessRequests([newReq, ...accessRequests]);
    alert('הבקשה נשלחה בהצלחה וממתינה לאישור מנהל.');
  };

  // Function to handle admin updates (Approve/Reject)
  const handleRequestUpdate = (requestId, status, note) => {
    const updatedRequests = accessRequests.map(req => {
      if (req.id === requestId) {
        return {
          ...req,
          status: status,
          log: [...req.log, note]
        };
      }
      return req;
    });
    setAccessRequests(updatedRequests);
    alert(`הבקשה עודכנה לסטטוס: ${status === 'approved' ? 'אושר' : 'נדחה'}`);
  };

  // Handle routing based on view state
  const renderContent = () => {
    switch (currentView) {
      case 'public':
        return <PublicSite />;

      case 'public-dashboards':
        return <PublicDashboards />;
      
      case 'login':
        return <LoginScreen onLogin={(user) => {
          setCurrentUser(user);
          // Redirect based on role
          if (user.role === ROLES.SUPPLIER) setCurrentView('supplier');
          else if (user.role === ROLES.EMPLOYEE) setCurrentView('authorized');
          else setCurrentView('admin');
        }} />;

      case 'authorized':
        if (!currentUser || (currentUser.role !== ROLES.EMPLOYEE && currentUser.role !== ROLES.ADMIN)) 
          return <AccessDenied />;
        return <AuthorizedSite 
          user={currentUser} 
          requests={accessRequests} 
          onRequestSubmit={handleNewRequest} 
        />;

      case 'catalog':
        if (!currentUser || (currentUser.role !== ROLES.EMPLOYEE && currentUser.role !== ROLES.ADMIN)) 
          return <AccessDenied />;
        return <DataCatalog currentUser={currentUser} />;

      case 'supplier':
        if (!currentUser || (currentUser.role !== ROLES.SUPPLIER && currentUser.role !== ROLES.ADMIN)) 
          return <AccessDenied />;
        return <SupplierPortal user={currentUser} />;

      case 'admin':
        if (!currentUser || currentUser.role !== ROLES.ADMIN) 
          return <AccessDenied />;
        return <PermissionsModule 
          requests={accessRequests} 
          onRequestUpdate={handleRequestUpdate} 
        />;
      
      case 'workflow':
        return <SystemWorkflow />;

      default:
        return <PublicSite />;
    }
  };

  return (
    <div dir="rtl" className="min-h-screen bg-slate-50 font-sans text-slate-900 flex flex-col">
      <Navbar 
        currentUser={currentUser} 
        currentView={currentView} 
        setView={setCurrentView}
        handleLogin={() => setCurrentView('login')}
        handleLogout={() => {
          setCurrentUser(null);
          setCurrentView('public');
        }}
      />

      <main className="flex-grow">
        {renderContent()}
      </main>

      <footer className="bg-slate-900 text-slate-400 py-8 border-t border-slate-800 mt-auto">
        <div className="max-w-7xl mx-auto px-4 flex flex-col md:flex-row justify-between items-center gap-4">
          <div className="text-sm">
            © 2024 מערכת אמו"ן מוניציפלי - כל הזכויות שמורות
          </div>
          <div className="flex items-center gap-6 text-xs font-mono">
            <span className="flex items-center gap-1 text-green-500">
              <Lock size={10} /> HTTPS Secured
            </span>
            <span>Version 2.4.0</span>
            <span>Status: Operational</span>
          </div>
        </div>
      </footer>

      {/* Security Banner Simulation */}
      <div className="bg-blue-600 text-white text-xs text-center py-1 px-4 fixed bottom-0 w-full z-50 md:hidden">
        מערכת מוגנת - שימוש ב-Cookies לצרכי אבטחה בלבד
      </div>
    </div>
  );
};

export default App;