<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת אמו"ן מוניציפלי - מתוקן</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: system-ui, -apple-system, sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.3s ease-out forwards;
        }

        #error-display {
            display: none;
            padding: 20px;
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #b91c1c;
            margin: 20px;
            border-radius: 8px;
            direction: ltr;
            font-family: monospace;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    
    <div id="error-display"></div>

    <div id="root">
        <div style="text-align:center; padding: 50px; color: #64748b;">
            <h2 style="font-size: 24px;">מערכת בטעינה...</h2>
            <p>אם הטקסט הזה לא נעלם תוך 5 שניות, כנראה יש חסימת רשת או שגיאת סקריפט.</p>
        </div>
    </div>

    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            const display = document.getElementById('error-display');
            display.style.display = 'block';
            display.innerHTML = `<strong>Error Detected:</strong><br/>${message}<br/><br/>Line: ${lineno}`;
            console.error(error);
        };
    </script>

    <script type="text/babel">
        // --- בדיקת טעינת ספריות ---
        if (!window.React || !window.ReactDOM || !window.lucide) {
            throw new Error("One or more libraries (React, ReactDOM, Lucide) failed to load from CDN.");
        }

        const { useState, useEffect } = React;
        
        // --- תיקון קריטי: שליפת האייקונים בצורה בטוחה ---
        // אנו משתמשים ב-window.lucide במקום destructing ישיר כדי למנוע קריסה
        const Icons = window.lucide.icons; 
        const { 
          Shield, Database, Users, Truck, Lock, Menu, X, LogIn, LogOut, Search, 
          FileText, Settings, Activity, Server, Eye, EyeOff, BarChart2, PieChart, 
          Map, ExternalLink, Filter, Maximize2, Fingerprint, ShieldCheck, FileKey,     
          History, AlertTriangle, Download, Tag, ChevronDown, ChevronUp, FileSpreadsheet, 
          CheckSquare, Upload, AlertCircle, CheckCircle, RefreshCw, FileJson, File,
          MessageSquare, Clock, UserCheck, UserX, Send, Share2, GitBranch, ArrowLeft,
          LayoutGrid, List, TrendingUp, Calendar, Bell, HelpCircle, Globe, Loader2,      
          MapPin, Table, MoreHorizontal, BadgeCheck, FileBarChart, Mail, FileCode,
          UserCog, ListFilter, Network
        } = Icons; // שימוש בגרסה המעודכנת של הספרייה

        // --- Mock Data ---
        const ROLES = { GUEST: 'guest', EMPLOYEE: 'employee', SUPPLIER: 'supplier', ADMIN: 'admin' };

        const MOCK_DATA_CATALOG = [
          { id: 1, name: 'נתוני מכירות Q3', type: 'Excel', classification: 'סודי ביותר', owner: 'מחלקת כספים', department: 'finance', tags: ['כספים', '2024'], size: '4.2 MB', qualityScore: 98, lastUpdate: '10/05/2024', rowCount: '14,500', description: 'פירוט עסקאות רבעוני כולל מע"מ וזיכויים.' },
          { id: 2, name: 'רשימת עובדים פעילים', type: 'SQL View', classification: 'פנימי', owner: 'משאבי אנוש', department: 'hr', tags: ['HR', 'עובדים'], size: 'Query', qualityScore: 100, lastUpdate: 'היום', rowCount: '1,240', description: 'מבט על עובדים פעילים.' },
          { id: 3, name: 'לוגים של שרתים', type: 'Elastic', classification: 'סודי', owner: 'IT', department: 'it', tags: ['Logs', 'Security'], size: '250 GB', qualityScore: 85, lastUpdate: 'בזמן אמת', rowCount: '~50M', description: 'לוגי תעבורה ושגיאות.' },
        ];

        const MOCK_PUBLIC_DASHBOARDS = [
          { id: 1, title: 'מדדי ביצוע (KPIs) 2024', description: 'סקירה שנתית של ביצועי החברה.', system: 'PowerBI', category: 'פיננסי', views: 12500, viewsDisplay: '12.5K', updated: '12/05/2024', icon: BarChart2, color: 'bg-yellow-500', type: 'charts' },
          { id: 2, title: 'מפת תשתיות ארצית', description: 'מפה אינטראקטיבית של פריסת סיבים.', system: 'Tableau', category: 'תפעול', views: 8200, viewsDisplay: '8.2K', updated: '10/05/2024', icon: Map, color: 'bg-blue-500', type: 'map' },
          { id: 3, title: 'שביעות רצון לקוחות', description: 'ניתוח סקרי שירות ומוקד.', system: 'Looker', category: 'שירות', views: 5600, viewsDisplay: '5.6K', updated: '09/05/2024', icon: PieChart, color: 'bg-purple-500', type: 'charts' },
        ];

        const MOCK_USERS = [
           { id: 1, name: 'ישראל ישראלי', role: 'employee', status: 'active', department: 'finance', lastLogin: 'היום, 09:41' },
           { id: 2, name: 'חברת אספקה בע"מ', role: 'supplier', status: 'active', department: 'external', lastLogin: 'אתמול, 14:20' },
           { id: 3, name: 'מנהל מערכת', role: 'admin', status: 'active', department: 'it', lastLogin: 'עכשיו' }
        ];

        // --- Components ---

        const Navbar = ({ currentUser, currentView, setView, handleLogin, handleLogout }) => {
          const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
          const [showNotifications, setShowNotifications] = useState(false);

          const NavItem = ({ view, label, icon: Icon, allowedRoles }) => {
            if (allowedRoles && (!currentUser || !allowedRoles.includes(currentUser.role))) return null;
            return (
              <button
                onClick={() => { setView(view); setIsMobileMenuOpen(false); }}
                className={`flex items-center gap-2 px-4 py-2 rounded-lg transition-colors duration-200 w-full md:w-auto text-right md:text-center ${currentView === view ? 'bg-blue-600 text-white shadow-md' : 'text-slate-600 hover:bg-slate-100 hover:text-blue-600'}`}
              >
                <Icon size={18} /> <span className="font-medium">{label}</span>
              </button>
            );
          };

          return (
            <nav className="bg-white shadow-lg sticky top-0 z-50 border-b border-slate-200">
              <div className="max-w-7xl mx-auto px-4">
                <div className="flex justify-between h-16">
                  <div className="flex items-center gap-2 cursor-pointer" onClick={() => setView('public')}>
                    <div className="bg-blue-600 p-2 rounded-lg"><Shield className="text-white" size={24} /></div>
                    <span className="text-xl font-bold text-blue-600 hidden sm:block">מערכת אמו"ן</span>
                  </div>
                  <div className="hidden md:flex items-center space-x-1 space-x-reverse">
                    <NavItem view="public" label="בית" icon={Server} />
                    <NavItem view="public-dashboards" label="דשבורדים" icon={BarChart2} />
                    <NavItem view="catalog" label="קטלוג דאטה" icon={Database} allowedRoles={[ROLES.EMPLOYEE, ROLES.ADMIN]} />
                    <NavItem view="admin" label="ניהול" icon={Lock} allowedRoles={[ROLES.ADMIN]} />
                  </div>
                  <div className="flex items-center gap-4">
                    {currentUser ? (
                      <button onClick={handleLogout} className="text-red-500 text-sm font-medium">התנתק</button>
                    ) : (
                      <button onClick={() => setView('login')} className="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm">התחברות</button>
                    )}
                  </div>
                </div>
              </div>
            </nav>
          );
        };

        const PublicSite = () => (
          <div className="animate-fade-in p-8 text-center">
            <h1 className="text-4xl font-bold text-slate-800 mb-4">תשתית ארגונית אחודה</h1>
            <p className="text-xl text-slate-600 max-w-2xl mx-auto mb-8">פלטפורמה מרכזית המאגדת את כלל השירותים הדיגיטליים של הארגון.</p>
            <div className="grid md:grid-cols-3 gap-6 max-w-4xl mx-auto">
                <div className="bg-white p-6 rounded-xl shadow border border-slate-100"><Shield className="mx-auto mb-2 text-blue-500"/><h3 className="font-bold">אבטחה</h3></div>
                <div className="bg-white p-6 rounded-xl shadow border border-slate-100"><Activity className="mx-auto mb-2 text-green-500"/><h3 className="font-bold">זמינות</h3></div>
                <div className="bg-white p-6 rounded-xl shadow border border-slate-100"><Users className="mx-auto mb-2 text-purple-500"/><h3 className="font-bold">שירות</h3></div>
            </div>
          </div>
        );

        const PublicDashboards = () => {
             return (
                 <div className="max-w-7xl mx-auto px-4 py-8 animate-fade-in">
                    <h2 className="text-2xl font-bold mb-6 flex items-center gap-2"><BarChart2 className="text-blue-600"/> דשבורדים ציבוריים</h2>
                    <div className="grid md:grid-cols-3 gap-6">
                        {MOCK_PUBLIC_DASHBOARDS.map(d => (
                            <div key={d.id} className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition">
                                <div className="flex items-center gap-3 mb-3">
                                    <div className={`p-2 rounded-lg ${d.color} text-white`}><d.icon size={20}/></div>
                                    <h3 className="font-bold text-slate-800">{d.title}</h3>
                                </div>
                                <p className="text-slate-500 text-sm mb-4">{d.description}</p>
                                <div className="text-xs text-slate-400 flex gap-4">
                                    <span className="flex items-center gap-1"><Eye size={12}/> {d.viewsDisplay}</span>
                                    <span className="flex items-center gap-1"><Server size={12}/> {d.system}</span>
                                </div>
                            </div>
                        ))}
                    </div>
                 </div>
             )
        }

        const DataCatalog = ({ currentUser }) => (
            <div className="max-w-7xl mx-auto px-4 py-8 animate-fade-in">
                <h2 className="text-2xl font-bold mb-6 flex items-center gap-2"><Database className="text-blue-600"/> קטלוג דאטה</h2>
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <table className="w-full text-right">
                        <thead className="bg-slate-50 border-b border-slate-200 text-sm text-slate-600">
                            <tr><th className="p-4">שם המאגר</th><th className="p-4">סיווג</th><th className="p-4">מחלקה</th><th className="p-4">פעולות</th></tr>
                        </thead>
                        <tbody>
                            {MOCK_DATA_CATALOG.map(item => (
                                <tr key={item.id} className="border-b border-slate-100 hover:bg-slate-50">
                                    <td className="p-4 font-bold text-slate-700">{item.name}</td>
                                    <td className="p-4"><span className="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs">{item.classification}</span></td>
                                    <td className="p-4 text-slate-600">{item.department}</td>
                                    <td className="p-4"><button className="text-blue-600 text-sm hover:underline">פרטים</button></td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </div>
        );

        const LoginScreen = ({ onLogin }) => (
            <div className="flex items-center justify-center min-h-[60vh]">
                <div className="bg-white p-8 rounded-2xl shadow-xl border border-slate-100 max-w-md w-full text-center">
                    <h2 className="text-2xl font-bold mb-6">התחברות להדגמה</h2>
                    <div className="space-y-3">
                        <button onClick={() => onLogin(MOCK_USERS[0])} className="w-full p-3 border rounded-lg hover:bg-blue-50 text-right">עובד (כספים)</button>
                        <button onClick={() => onLogin(MOCK_USERS[1])} className="w-full p-3 border rounded-lg hover:bg-blue-50 text-right">ספק חיצוני</button>
                        <button onClick={() => onLogin(MOCK_USERS[2])} className="w-full p-3 border rounded-lg hover:bg-blue-50 text-right font-bold">מנהל מערכת (Admin)</button>
                    </div>
                </div>
            </div>
        );

        const App = () => {
            const [currentUser, setCurrentUser] = useState(null);
            const [currentView, setCurrentView] = useState('public');

            const renderContent = () => {
                switch(currentView) {
                    case 'public': return <PublicSite />;
                    case 'public-dashboards': return <PublicDashboards />;
                    case 'catalog': return <DataCatalog currentUser={currentUser} />;
                    case 'login': return <LoginScreen onLogin={(u) => { setCurrentUser(u); setCurrentView('public'); }} />;
                    case 'admin': return <div className="p-8 text-center text-xl">אזור ניהול (Admin)</div>;
                    default: return <PublicSite />;
                }
            };

            return (
                <div dir="rtl" className="min-h-screen bg-slate-50 font-sans text-slate-900 flex flex-col">
                    <Navbar 
                        currentUser={currentUser} 
                        currentView={currentView} 
                        setView={setCurrentView} 
                        handleLogin={() => setCurrentView('login')}
                        handleLogout={() => setCurrentUser(null)}
                    />
                    <main className="flex-grow">{renderContent()}</main>
                    <footer className="bg-slate-900 text-slate-400 py-6 text-center text-sm">© 2024 מערכת אמו"ן מוניציפלי</footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
